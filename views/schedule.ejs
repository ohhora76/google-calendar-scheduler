<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= displayName %> - ìŠ¤ì¼€ì¤„</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="calendar-container">
        <header class="calendar-header">
            <h1><%= displayName %></h1>
            <div class="calendar-nav">
                <button onclick="navigateMonth(-1)" class="nav-btn">â€¹ ì´ì „</button>
                <h2 class="current-month">
                    <%= currentYear %>ë…„ <%= currentMonth %>ì›”
                </h2>
                <button onclick="navigateMonth(1)" class="nav-btn">ë‹¤ìŒ â€º</button>
            </div>
        </header>

        <main class="calendar-main">
            <div class="calendar-grid">
                <div class="calendar-weekdays">
                    <div class="weekday">ì¼</div>
                    <div class="weekday">ì›”</div>
                    <div class="weekday">í™”</div>
                    <div class="weekday">ìˆ˜</div>
                    <div class="weekday">ëª©</div>
                    <div class="weekday">ê¸ˆ</div>
                    <div class="weekday">í† </div>
                </div>
                
                <div class="calendar-days" id="calendarDays">
                    <!-- ë‹¬ë ¥ ë‚ ì§œë“¤ì´ JavaScriptë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </main>

        <div id="eventModal" class="event-modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h3 id="modalDate"></h3>
                <div id="modalEvents"></div>
            </div>
        </div>

        <footer class="calendar-footer">
            <p>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <%= new Date().toLocaleString('ko-KR') %></p>
        </footer>
    </div>

    <script>
        const events = <%- JSON.stringify(events) %>;
        const currentYear = <%= currentYear %>;
        const currentMonth = <%= currentMonth %>;
        const pageName = '<%= pageName %>';
        const showDetails = <%= showDetails %>;
        
        function navigateMonth(direction) {
            let newYear = currentYear;
            let newMonth = currentMonth + direction;
            
            if (newMonth < 1) {
                newMonth = 12;
                newYear--;
            } else if (newMonth > 12) {
                newMonth = 1;
                newYear++;
            }
            
            window.location.href = `/schedule/${pageName}?year=${newYear}&month=${newMonth}`;
        }
        
        function generateCalendar() {
            const calendarDays = document.getElementById('calendarDays');
            const firstDay = new Date(currentYear, currentMonth - 1, 1);
            const lastDay = new Date(currentYear, currentMonth, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // ì´ì „ ë‹¬ì˜ ë‚ ì§œë“¤
            const prevMonthDays = new Date(currentYear, currentMonth - 1, 0).getDate();
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const dayElement = createDayElement(prevMonthDays - i, 'prev-month');
                calendarDays.appendChild(dayElement);
            }
            
            // í˜„ì¬ ë‹¬ì˜ ë‚ ì§œë“¤
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = createDayElement(day, 'current-month');
                const dayEvents = getEventsForDay(day);
                
                if (dayEvents.length > 0) {
                    if (showDetails) {
                        dayElement.classList.add('has-events', 'clickable');
                        dayElement.onclick = () => showEvents(day, dayEvents);
                    } else {
                        dayElement.classList.add('has-events', 'private');
                        dayElement.title = 'ì¼ì •ì´ ìˆì§€ë§Œ ìƒì„¸ë‚´ìš©ì€ ë¹„ê³µê°œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.';
                    }
                }
                
                calendarDays.appendChild(dayElement);
            }
            
            // ë‹¤ìŒ ë‹¬ì˜ ë‚ ì§œë“¤ (6ì£¼ ì™„ì„±)
            const totalCells = calendarDays.children.length;
            const remainingCells = 42 - totalCells; // 6ì£¼ Ã— 7ì¼
            for (let day = 1; day <= remainingCells; day++) {
                const dayElement = createDayElement(day, 'next-month');
                calendarDays.appendChild(dayElement);
            }
        }
        
        function createDayElement(day, monthClass) {
            const dayDiv = document.createElement('div');
            dayDiv.className = `calendar-day ${monthClass}`;
            dayDiv.innerHTML = `<span class="day-number">${day}</span>`;
            return dayDiv;
        }
        
        function getEventsForDay(day) {
            return events.filter(event => {
                const eventDate = new Date(event.start.dateTime || event.start.date);
                return eventDate.getDate() === day && 
                       eventDate.getMonth() === currentMonth - 1 && 
                       eventDate.getFullYear() === currentYear;
            });
        }
        
        function showEvents(day, dayEvents) {
            const modal = document.getElementById('eventModal');
            const modalDate = document.getElementById('modalDate');
            const modalEvents = document.getElementById('modalEvents');
            
            modalDate.textContent = `${currentYear}ë…„ ${currentMonth}ì›” ${day}ì¼`;
            
            modalEvents.innerHTML = '';
            dayEvents.forEach(event => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'modal-event';
                
                let timeStr = '';
                if (event.start.dateTime) {
                    const startTime = new Date(event.start.dateTime);
                    const endTime = event.end.dateTime ? new Date(event.end.dateTime) : null;
                    timeStr = startTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                    if (endTime) {
                        timeStr += ' - ' + endTime.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                    }
                } else {
                    timeStr = 'ì¢…ì¼';
                }
                
                let eventContent = `
                    <div class="event-time">${timeStr}</div>
                    <div class="event-title">${event.summary || 'ì œëª© ì—†ìŒ'}</div>
                `;
                
                if (showDetails) {
                    if (event.description) {
                        eventContent += `<div class="event-description">${event.description}</div>`;
                    }
                    if (event.location) {
                        eventContent += `<div class="event-location">ğŸ“ ${event.location}</div>`;
                    }
                }
                
                eventDiv.innerHTML = eventContent;
                
                modalEvents.appendChild(eventDiv);
            });
            
            modal.style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('eventModal').style.display = 'none';
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const modal = document.getElementById('eventModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œì‹œ ë‹¬ë ¥ ìƒì„±
        generateCalendar();
        
        // ìë™ ìƒˆë¡œê³ ì¹¨ (5ë¶„ë§ˆë‹¤)
        setTimeout(() => {
            location.reload();
        }, 5 * 60 * 1000);
    </script>
</body>
</html>